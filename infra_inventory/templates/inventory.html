<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IFT Inventory</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .filter-section {
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 5px;
        }
        .website-card {
            margin-bottom: 15px;
            transition: transform 0.2s;
        }
        .website-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .tag {
            margin-right: 5px;
            margin-bottom: 5px;
        }
        .search-container {
            margin-bottom: 20px;
        }
        .theme-toggle {
            position: absolute;
            top: 15px;
            right: 15px;
            z-index: 1000;
        }
        .theme-toggle-btn {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        h1 {
          text-align: center;
        }
        .env-tabs {
            margin-bottom: 20px;
            border-bottom: 1px solid #dee2e6;
        }
        .env-tabs .nav-link {
            border: 1px solid transparent;
            border-bottom: none;
            border-radius: 0.25rem 0.25rem 0 0;
            padding: 0.5rem 1rem;
            margin-right: 0.25rem;
        }
        .env-tabs .nav-link.active {
            background-color: #fff;
            border-color: #dee2e6 #dee2e6 #fff;
            color: #495057;
        }
        .env-tabs .nav-link:not(.active):hover {
            border-color: #e9ecef #e9ecef #dee2e6;
        }
        .data-bs-theme-dark .env-tabs .nav-link.active {
            background-color: #212529;
            border-color: #495057 #495057 #212529;
            color: #fff;
        }
        .loading-spinner {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            vertical-align: text-bottom;
            border: 0.2em solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            animation: spinner-border 0.75s linear infinite;
            margin-left: 5px;
        }
        @keyframes spinner-border {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="theme-toggle">
        <button id="theme-toggle-btn" class="btn btn-sm btn-outline-secondary theme-toggle-btn">
            <i id="theme-icon" class="bi bi-moon-stars"></i>
            <span id="theme-text">Dark Mode</span>
        </button>
    </div>

    <div class="container mt-4">
        <h1 class="mb-4">Website Inventory</h1>

        <div class="search-container">
            <div class="input-group mb-3">
                <input type="text" id="search-input" class="form-control" placeholder="Search websites by name, description, or tags..." aria-label="Search websites">
                <button class="btn btn-outline-secondary" type="button" id="search-button">Search</button>
            </div>
        </div>

        <!-- Environment Tabs -->
        <div class="env-tabs">
            <ul class="nav nav-tabs">
                <li class="nav-item">
                    <a class="nav-link active" href="#" data-filter="all">All</a>
                </li>
                {% for env in environments %}
                <li class="nav-item">
                    <a class="nav-link" href="#" data-filter="{{ env }}">{{ env }}</a>
                </li>
                {% endfor %}
            </ul>
        </div>

        <div class="row">
            <div class="col-md-3">
                <div class="filter-section">
                    <h5>Filters</h5>

                    <div class="mb-3">
                        <h6>Stage <span id="stage-loading-spinner" class="loading-spinner" style="display: none;"></span></h6>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="stage-all" checked>
                            <label class="form-check-label" for="stage-all">All</label>
                        </div>
                        <div id="stage-filters-container">
                            {% for stage in stages['all'] %}
                            <div class="form-check">
                                <input class="form-check-input stage-filter" type="checkbox" value="{{ stage }}" id="stage-{{ loop.index }}" checked>
                                <label class="form-check-label" for="stage-{{ loop.index }}">{{ stage }}</label>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <div class="mb-3">
                        <h6>Tags <span id="tag-loading-spinner" class="loading-spinner" style="display: none;"></span></h6>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="tag-all" checked>
                            <label class="form-check-label" for="tag-all">All</label>
                        </div>
                        <div id="tag-filters-container">
                            {% for tag in tags['all'] %}
                            <div class="form-check">
                                <input class="form-check-input tag-filter" type="checkbox" value="{{ tag }}" id="tag-{{ loop.index }}" checked>
                                <label class="form-check-label" for="tag-{{ loop.index }}">{{ tag }}</label>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-9">
                <div id="website-list" class="row">
                    {% for site in websites %}
                    <div class="col-md-6">
                        <div class="card website-card">
                            <div class="card-body">
                                <h5 class="card-title">{{ site.url }}</h5>
                                <h6 class="card-subtitle mb-2 text-muted">
                                    env: {{ site.environment }} | stage: {{ site.stage }}
                                </h6>
                                <a href="{{ site.url }}" target="_blank" class="card-link">Visit Website</a>
                                <div class="mt-2">
                                    {% for tag in site.tags %}
                                    <span class="badge bg-secondary tag">{{ tag }}</span>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    <footer>
    <p>This website is generated based on Infra Inventory, contact the infra team on discord for any request.</p>
    </footer>
    <!-- Bootstrap Icons for theme toggle -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function() {
            // Theme toggle functionality
            const themeToggleBtn = document.getElementById('theme-toggle-btn');
            const themeIcon = document.getElementById('theme-icon');
            const themeText = document.getElementById('theme-text');
            const htmlElement = document.documentElement;

            // Check for saved theme preference or use preferred color scheme
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

            if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
                htmlElement.setAttribute('data-bs-theme', 'dark');
                themeIcon.className = 'bi bi-sun';
                themeText.textContent = 'Light Mode';
            }

            themeToggleBtn.addEventListener('click', () => {
                const currentTheme = htmlElement.getAttribute('data-bs-theme');
                const newTheme = currentTheme === 'light' ? 'dark' : 'light';

                htmlElement.setAttribute('data-bs-theme', newTheme);
                localStorage.setItem('theme', newTheme);

                // Update button appearance
                if (newTheme === 'dark') {
                    themeIcon.className = 'bi bi-sun';
                    themeText.textContent = 'Light Mode';
                } else {
                    themeIcon.className = 'bi bi-moon-stars';
                    themeText.textContent = 'Dark Mode';
                }
            });

            // Function to load stages and tags for a specific environment
            function loadFiltersForEnvironment(environment) {
                // Show loading spinners
                $('#stage-loading-spinner').show();
                $('#tag-loading-spinner').show();

                // Load stages
                $.get('/get_stages', {environment: environment}, function(stages) {
                    const $stageContainer = $('#stage-filters-container');
                    $stageContainer.empty();

                    stages.forEach(function(stage, index) {
                        $stageContainer.append(`
                            <div class="form-check">
                                <input class="form-check-input stage-filter" type="checkbox" value="${stage}" id="stage-${index}" checked>
                                <label class="form-check-label" for="stage-${index}">${stage}</label>
                            </div>
                        `);
                    });

                    $('#stage-loading-spinner').hide();
                });

                // Load tags
                $.get('/get_tags', {environment: environment}, function(tags) {
                    const $tagContainer = $('#tag-filters-container');
                    $tagContainer.empty();

                    tags.forEach(function(tag, index) {
                        $tagContainer.append(`
                            <div class="form-check">
                                <input class="form-check-input tag-filter" type="checkbox" value="${tag}" id="tag-${index}" checked>
                                <label class="form-check-label" for="tag-${index}">${tag}</label>
                            </div>
                        `);
                    });

                    $('#tag-loading-spinner').hide();
                });
            }

            // Handle filter changes with debounce
            let filterTimeout;
            const filterWebsites = function() {
                clearTimeout(filterTimeout);
                filterTimeout = setTimeout(() => {
                    const environments = [];
                    const stages = [];
                    const tags = [];
                    const searchTerm = $('#search-input').val();

                    // Get active environment tab
                    const activeEnvTab = $('.env-tabs .nav-link.active').data('filter');
                    if (activeEnvTab && activeEnvTab !== 'all') {
                        environments.push(activeEnvTab);
                    }

                    // Get selected stages
                    $('.stage-filter:checked').each(function() {
                        stages.push($(this).val());
                    });

                    // Get selected tags
                    $('.tag-filter:checked').each(function() {
                        tags.push($(this).val());
                    });

                    // If "All" is checked, we don't need to send specific filters
                    const envParam = environments.length === 0 ? '' : environments.join(',');
                    const stageParam = $('#stage-all').is(':checked') ? '' : stages.join(',');
                    const tagParam = $('#tag-all').is(':checked') ? '' : tags.join(',');

                    // Make AJAX request
                    $.get('/filter', {
                        environment: envParam,
                        stage: stageParam,
                        tag: tagParam,
                        search: searchTerm
                    }, function(data) {
                        updateWebsiteList(data);
                    });
                }, 300);
            };

            // Update website list with filtered data
            const updateWebsiteList = function(websites) {
                const $list = $('#website-list');
                $list.empty();

                if (websites.length === 0) {
                    $list.append('<div class="col-12"><div class="alert alert-info">No websites match your filters</div></div>');
                    return;
                }

                websites.forEach(function(site) {
                    let tagsHtml = '';
                    site.tags.forEach(function(tag) {
                        tagsHtml += `<span class="badge bg-secondary tag">${tag}</span>`;
                    });

                    const cardHtml = `
                        <div class="col-md-6">
                            <div class="card website-card">
                                <div class="card-body">
                                    <h5 class="card-title">${site.url}</h5>
                                    <h6 class="card-subtitle mb-2 text-muted">
                                        env: ${site.environment} | stage: ${site.stage}
                                    </h6>
                                    <a href="${site.url}" target="_blank" class="card-link">Visit Website</a>
                                    <div class="mt-2">
                                        ${tagsHtml}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    $list.append(cardHtml);
                });
            };

            // Event handlers for environment tabs
            $('.env-tabs .nav-link').click(function(e) {
                e.preventDefault();
                $('.env-tabs .nav-link').removeClass('active');
                $(this).addClass('active');

                const environment = $(this).data('filter');

                // Reset "All" checkboxes
                $('#stage-all').prop('checked', true);
                $('#tag-all').prop('checked', true);

                // Load filters for the selected environment
                if (environment !== 'all') {
                    loadFiltersForEnvironment(environment);
                } else {
                    // Reload all filters
                    location.reload();
                }

                filterWebsites();
            });

            // Event handlers for filter changes
            $(document).on('change', '.stage-filter, .tag-filter', function() {
                // If any specific filter is checked, uncheck "All"
                if ($(this).is(':checked') && $(this).attr('id') !== 'stage-all' && $(this).attr('id') !== 'tag-all') {
                    const allId = $(this).hasClass('stage-filter') ? 'stage-all' : 'tag-all';
                    $('#' + allId).prop('checked', false);
                }
                filterWebsites();
            });

            // Handle "All" checkboxes
            $(document).on('change', '#stage-all, #tag-all', function() {
                const filterClass = $(this).attr('id') === 'stage-all' ? '.stage-filter' : '.tag-filter';

                if ($(this).is(':checked')) {
                    $(filterClass).prop('checked', true);
                }
                filterWebsites();
            });

            // Handle search input
            $('#search-input').on('input', filterWebsites);
            $('#search-button').click(filterWebsites);
        });
    </script>
</body>
</html>
